#!/usr/bin/env python3

import os
import shlex
import shutil
import subprocess
import sys

from pathlib import Path


#: The environment variable for the Java home directory.
JAVA_HOME_ENVS = (
    'JDTLS_JAVA_HOME',
    'JAVA_HOME',
)

#: The environment variable for additional JVM arguments.
JVM_ARGS_ENV = 'JDTLS_JVM_ARGS'

#: The name of the Java binary.
JAVA_BIN = 'java'

#: The path to the jdtls installation.
JDTLS_PATH = Path.home() / '.local' / 'lib' / 'jdtls'


def main(java_home: Path, *args):
    jvm_args = [
        f'--jvm-arg={arg}'
        for arg in shlex.split(os.environ.get(JVM_ARGS_ENV, ''))]
    subprocess.check_call(
        [sys.executable, JDTLS_PATH / 'bin' / 'jdtls']
            + jvm_args
            + list(args),
        env={
            **os.environ,
            'JAVA_HOME': str(java_home),
        })


if __name__ == '__main__':
    def java_home():
        try:
            return Path(next(
                os.environ[java_home]
                for java_home in JAVA_HOME_ENVS
                if java_home in os.environ))
        except StopIteration:
            java_bin = shutil.which(JAVA_BIN)
            if java_bin is None:
                print('Cannot find java executable')
                sys.exit(1)
            else:
                java_bin = Path(java_bin)
                while True:
                    try:
                        java_bin = java_bin.readlink()
                    except OSError:
                        break
                return java_bin.parent.parent

    main(java_home(), *sys.argv[1:])
