#!/usr/bin/env python3
#
## Creates a checkpoint commit with current changes.
##
## This command is interactive; no files will be added without user
## confirmation.

import subprocess

from datetime import datetime
from pathlib import Path
from typing import List, Tuple


def main():
    files_to_add = [
        path
        for (status, path) in files()
        if check_addition((status, path))]
    if files_to_add:
        message = f'Checkpoint {datetime.now().isoformat(timespec="minutes")}'
        subprocess.check_call(['git', 'add', *map(str, files_to_add)])
        subprocess.check_call(['git', 'commit', '--message', message])
    else:
        print('No files to add.')


def files() -> List[Tuple[str, Path]]:
    for line in subprocess.check_output(
            ["git", "status", "--short"]).decode("utf-8").splitlines():
        status, filename = line.split(maxsplit=1)
        yield status, Path(filename)


def check_addition(file: Tuple[str, Path]) -> bool:
    (status, filename) = file
    match status:
        case "??":
            return confirm_addition(filename)
        case _:
            return True


def confirm_addition(filename: Path) -> bool:
    while True:
        r = input(f'Add untracked file \033[0;32m{filename}\033[0m? [y/n] ')
        match r.lower():
            case 'yes' | 'y':
                return True
            case 'no' | 'n':
                return False
            case _:
                print("Please answer 'yes' or 'no'.")


if __name__ == "__main__":
    main()
